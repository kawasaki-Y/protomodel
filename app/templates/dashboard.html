{% extends "base.html" %}

{% block title %}ダッシュボード | 事業計画システム{% endblock %}

{% block page_title %}ダッシュボード{% endblock %}

{% block page_actions %}
<div class="flex space-x-2">
    <button id="exportPdfBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
        <i class="fas fa-file-pdf mr-2"></i> PDF出力
    </button>
    <button id="exportPptBtn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded">
        <i class="fas fa-file-powerpoint mr-2"></i> PPT出力
    </button>
</div>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- 主要指標カード -->
    <div id="salesCard" class="bg-blue-50 p-4 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-blue-800 mb-4">売上高</h3>
        <div class="flex items-end space-x-4">
            <div class="text-3xl font-bold metric-value">¥0</div>
            <div class="text-sm text-green-600">
                <i class="fas fa-arrow-up mr-1"></i> 0%
            </div>
        </div>
    </div>
    
    <div id="profitCard" class="bg-green-50 p-4 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-green-800 mb-4">営業利益</h3>
        <div class="flex items-end space-x-4">
            <div class="text-3xl font-bold metric-value">¥0</div>
            <div class="text-sm text-green-600">
                <i class="fas fa-arrow-up mr-1"></i> 0%
            </div>
        </div>
    </div>
    
    <div class="bg-yellow-50 p-4 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-yellow-800 mb-4">当期純利益</h3>
        <div class="flex items-end space-x-4">
            <div class="text-3xl font-bold metric-value">¥0</div>
            <div class="text-sm text-green-600">
                <i class="fas fa-arrow-up mr-1"></i> 0%
            </div>
        </div>
    </div>
    
    <div id="cashCard" class="bg-purple-50 p-4 rounded-lg shadow">
        <h3 class="text-lg font-semibold text-purple-800 mb-4">期末資金残高</h3>
        <div class="flex items-end space-x-4">
            <div class="text-3xl font-bold metric-value">¥0</div>
            <div class="text-sm text-green-600">
                <i class="fas fa-arrow-up mr-1"></i> 0%
            </div>
        </div>
    </div>
</div>

<!-- グラフセクション -->
<div class="mb-8">
    <h3 class="text-xl font-semibold mb-4 text-gray-700">月次推移</h3>
    <div class="bg-white p-4 rounded-lg shadow-md">
        <canvas id="revenueChart" height="300"></canvas>
    </div>
</div>

<!-- テーブルセクション -->
<div class="mb-8">
    <h3 class="text-xl font-semibold mb-4 text-gray-700">事業計画一覧</h3>
    
    {% if current_plans %}
    <div class="mb-6">
        <h4 class="text-lg font-medium mb-3 text-gray-600">単年事業計画</h4>
        <div class="overflow-x-auto">
            <table class="min-w-full border-collapse">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 tracking-wider border">計画名</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 tracking-wider border">会計年度</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 tracking-wider border">期間</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 tracking-wider border">作成日</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 tracking-wider border">アクション</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plan in current_plans %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 text-sm text-gray-700 border">{{ plan.name }}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 border">{{ plan.fiscal_year }}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 border">{{ plan.start_month }}月～{{ plan.end_month }}月</td>
                        <td class="px-4 py-2 text-sm text-gray-700 border">{{ plan.created_at.strftime('%Y/%m/%d') }}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 border">
                            <a href="{{ url_for('business_plan.current_plan') }}" class="text-blue-600 hover:underline">表示</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if next_plans %}
    <div>
        <h4 class="text-lg font-medium mb-3 text-gray-600">来期事業計画</h4>
        <div class="overflow-x-auto">
            <table class="min-w-full border-collapse">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 tracking-wider border">計画名</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 tracking-wider border">会計年度</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 tracking-wider border">期間</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 tracking-wider border">作成日</th>
                        <th class="px-4 py-2 text-left text-sm font-medium text-gray-600 tracking-wider border">アクション</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plan in next_plans %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 text-sm text-gray-700 border">{{ plan.name }}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 border">{{ plan.fiscal_year }}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 border">{{ plan.start_month }}月～{{ plan.end_month }}月</td>
                        <td class="px-4 py-2 text-sm text-gray-700 border">{{ plan.created_at.strftime('%Y/%m/%d') }}</td>
                        <td class="px-4 py-2 text-sm text-gray-700 border">
                            <a href="{{ url_for('business_plan.next_plan') }}" class="text-blue-600 hover:underline">表示</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if not current_plans and not next_plans %}
    <div class="text-center py-8">
        <p class="text-gray-500 mb-4">まだ事業計画が作成されていません。</p>
        <div class="space-x-4">
            <a href="{{ url_for('business_plan.current_plan') }}" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded">
                単年事業計画を作成
            </a>
            <a href="{{ url_for('business_plan.next_plan') }}" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded">
                来期事業計画を作成
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // チャートデータのAPIリクエスト
    fetch('/api/dashboard/chart-data')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('APIエラー:', data.error);
                return;
            }
            
            // Chart.jsでグラフ作成
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const revenueChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '売上・利益・資金残高の推移',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('ja-JP', { 
                                            style: 'currency', 
                                            currency: 'JPY' 
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '月'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '金額（円）'
                            },
                            ticks: {
                                callback: function(value) {
                                    return new Intl.NumberFormat('ja-JP', { 
                                        style: 'currency', 
                                        currency: 'JPY',
                                        notation: 'compact',
                                        compactDisplay: 'short'
                                    }).format(value);
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('フェッチエラー:', error);
        });
        
    // PDFエクスポートボタン
    document.getElementById('exportPdfBtn').addEventListener('click', function() {
        exportPdf();
    });
    
    // PPTエクスポートボタン
    document.getElementById('exportPptBtn').addEventListener('click', function() {
        exportPpt();
    });
});
</script>

<!-- ダッシュボード用JavaScript -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %} 